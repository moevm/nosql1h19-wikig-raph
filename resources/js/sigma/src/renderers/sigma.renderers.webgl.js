(function(y){"use strict";if("undefined"==typeof sigma)throw"sigma is not declared";sigma.utils.pkg("sigma.renderers"),sigma.renderers.webgl=function(t,e,s,i){if("object"!=typeof i)throw"sigma.renderers.webgl: Wrong arguments.";if(!(i.container instanceof HTMLElement))throw"Container not found.";var r,a,n,h;for(sigma.classes.dispatcher.extend(this),this.jobs={},Object.defineProperty(this,"conradId",{value:sigma.utils.id()}),this.graph=t,this.camera=e,this.contexts={},this.domElements={},this.options=i,this.container=this.options.container,this.settings="object"==typeof i.settings&&i.settings?s.embedObjects(i.settings):s,this.options.prefix=this.camera.readPrefix,Object.defineProperty(this,"nodePrograms",{value:{}}),Object.defineProperty(this,"edgePrograms",{value:{}}),Object.defineProperty(this,"nodeFloatArrays",{value:{}}),Object.defineProperty(this,"edgeFloatArrays",{value:{}}),Object.defineProperty(this,"edgeIndicesArrays",{value:{}}),this.settings(i,"batchEdgesDrawing")?(this.initDOM("canvas","edges",!0),this.initDOM("canvas","nodes",!0)):(this.initDOM("canvas","scene",!0),this.contexts.nodes=this.contexts.scene,this.contexts.edges=this.contexts.scene),this.initDOM("canvas","labels"),this.initDOM("canvas","mouse"),this.contexts.hover=this.contexts.mouse,this.captors=[],r=0,a=(n=this.options.captors||[sigma.captors.mouse,sigma.captors.touch]).length;r<a;r++)h="function"==typeof n[r]?n[r]:sigma.captors[n[r]],this.captors.push(new h(this.domElements.mouse,this.camera,this.settings));sigma.misc.bindEvents.call(this,this.camera.prefix),sigma.misc.drawHovers.call(this,this.camera.prefix),this.resize()},sigma.renderers.webgl.prototype.process=function(){var t,e,s,i,r,a,n=this.graph,h=sigma.utils.extend(h,this.options),o=this.settings(h,"defaultEdgeType"),g=this.settings(h,"defaultNodeType");for(i in this.nodeFloatArrays)delete this.nodeFloatArrays[i];for(i in this.edgeFloatArrays)delete this.edgeFloatArrays[i];for(i in this.edgeIndicesArrays)delete this.edgeIndicesArrays[i];for(e=0,s=(t=n.edges()).length;e<s;e++)i=(r=t[e].type||o)&&sigma.webgl.edges[r]?r:"def",this.edgeFloatArrays[i]||(this.edgeFloatArrays[i]={edges:[]}),this.edgeFloatArrays[i].edges.push(t[e]);for(e=0,s=(t=n.nodes()).length;e<s;e++)i=(r=t[e].type||g)&&sigma.webgl.nodes[r]?r:"def",this.nodeFloatArrays[i]||(this.nodeFloatArrays[i]={nodes:[]}),this.nodeFloatArrays[i].nodes.push(t[e]);for(i in this.edgeFloatArrays){for(a=sigma.webgl.edges[i],t=this.edgeFloatArrays[i].edges,this.edgeFloatArrays[i].array=new Float32Array(t.length*a.POINTS*a.ATTRIBUTES),e=0,s=t.length;e<s;e++)t[e].hidden||n.nodes(t[e].source).hidden||n.nodes(t[e].target).hidden||a.addEdge(t[e],n.nodes(t[e].source),n.nodes(t[e].target),this.edgeFloatArrays[i].array,e*a.POINTS*a.ATTRIBUTES,h.prefix,this.settings);"function"==typeof a.computeIndices&&(this.edgeIndicesArrays[i]=a.computeIndices(this.edgeFloatArrays[i].array))}for(i in this.nodeFloatArrays)for(a=sigma.webgl.nodes[i],t=this.nodeFloatArrays[i].nodes,this.nodeFloatArrays[i].array=new Float32Array(t.length*a.POINTS*a.ATTRIBUTES),e=0,s=t.length;e<s;e++)this.nodeFloatArrays[i].array||(this.nodeFloatArrays[i].array=new Float32Array(t.length*a.POINTS*a.ATTRIBUTES)),t[e].hidden||a.addNode(t[e],this.nodeFloatArrays[i].array,e*a.POINTS*a.ATTRIBUTES,h.prefix,this.settings);return this},sigma.renderers.webgl.prototype.render=function(t){var e,s,i,r,a,n,h=this,o=(this.graph,this.contexts.nodes),d=this.contexts.edges,l=this.camera.getMatrix(),c=sigma.utils.extend(t,this.options),g=this.settings(c,"drawLabels"),m=this.settings(c,"drawEdges"),p=this.settings(c,"drawNodes");for(r in this.resize(!1),this.settings(c,"hideEdgesOnMove")&&(this.camera.isAnimated||this.camera.isMoving)&&(m=!1),this.clear(),l=sigma.utils.matrices.multiply(l,sigma.utils.matrices.translation(this.width/2,this.height/2)),this.jobs)conrad.hasJob(r)&&conrad.killJob(r);if(m)if(this.settings(c,"batchEdgesDrawing"))(function(){var t,e,s,i,r,a,n,h,o,g;s="edges_"+this.conradId,g=this.settings(c,"webglEdgesBatchSize"),(t=Object.keys(this.edgeFloatArrays)).length&&(e=0,o=sigma.webgl.edges[t[e]],r=this.edgeFloatArrays[t[e]].array,h=this.edgeIndicesArrays[t[e]],n=0,a=Math.min(n+g*o.POINTS,r.length/o.ATTRIBUTES),i=function(){return this.edgePrograms[t[e]]||(this.edgePrograms[t[e]]=o.initProgram(d)),n<a&&(d.useProgram(this.edgePrograms[t[e]]),o.render(d,this.edgePrograms[t[e]],r,{settings:this.settings,matrix:l,width:this.width,height:this.height,ratio:this.camera.ratio,scalingRatio:this.settings(c,"webglOversamplingRatio"),start:n,count:a-n,indicesData:h})),a>=r.length/o.ATTRIBUTES&&e===t.length-1?(delete this.jobs[s],!1):(a=(n=a>=r.length/o.ATTRIBUTES?(e++,r=this.edgeFloatArrays[t[e]].array,o=sigma.webgl.edges[t[e]],0):a,Math.min(n+g*o.POINTS,r.length/o.ATTRIBUTES)),!0)},this.jobs[s]=i,conrad.addJob(s,i.bind(this)))}).call(this);else for(r in this.edgeFloatArrays)n=sigma.webgl.edges[r],this.edgePrograms[r]||(this.edgePrograms[r]=n.initProgram(d)),this.edgeFloatArrays[r]&&(d.useProgram(this.edgePrograms[r]),n.render(d,this.edgePrograms[r],this.edgeFloatArrays[r].array,{settings:this.settings,matrix:l,width:this.width,height:this.height,ratio:this.camera.ratio,scalingRatio:this.settings(c,"webglOversamplingRatio"),indicesData:this.edgeIndicesArrays[r]}));if(p)for(r in o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.enable(o.BLEND),this.nodeFloatArrays)n=sigma.webgl.nodes[r],this.nodePrograms[r]||(this.nodePrograms[r]=n.initProgram(o)),this.nodeFloatArrays[r]&&(o.useProgram(this.nodePrograms[r]),n.render(o,this.nodePrograms[r],this.nodeFloatArrays[r].array,{settings:this.settings,matrix:l,width:this.width,height:this.height,ratio:this.camera.ratio,scalingRatio:this.settings(c,"webglOversamplingRatio")}));if(g)for(e=this.camera.quadtree.area(this.camera.getRectangle(this.width,this.height)),this.camera.applyView(y,y,{nodes:e,edges:[],width:this.width,height:this.height}),a=function(t){return h.settings({prefix:h.camera.prefix},t)},s=0,i=e.length;s<i;s++)e[s].hidden||(sigma.canvas.labels[e[s].type||this.settings(c,"defaultNodeType")]||sigma.canvas.labels.def)(e[s],this.contexts.labels,a);return this.dispatchEvent("render"),this},sigma.renderers.webgl.prototype.initDOM=function(t,e,s){var i=document.createElement(t),r=this;i.style.position="absolute",i.setAttribute("class","sigma-"+e),this.domElements[e]=i,this.container.appendChild(i),"canvas"===t.toLowerCase()&&(this.contexts[e]=i.getContext(s?"experimental-webgl":"2d",{preserveDrawingBuffer:!0}),s&&(i.addEventListener("webglcontextlost",function(t){t.preventDefault()},!1),i.addEventListener("webglcontextrestored",function(t){r.render()},!1)))},sigma.renderers.webgl.prototype.resize=function(t,e){var s,i=this.width,r=this.height,a=sigma.utils.getPixelRatio();if(t!==y&&e!==y?(this.width=t,this.height=e):(this.width=this.container.offsetWidth,this.height=this.container.offsetHeight,t=this.width,e=this.height),i!==this.width||r!==this.height)for(s in this.domElements)this.domElements[s].style.width=t+"px",this.domElements[s].style.height=e+"px","canvas"===this.domElements[s].tagName.toLowerCase()&&(this.contexts[s]&&this.contexts[s].scale?(this.domElements[s].setAttribute("width",t*a+"px"),this.domElements[s].setAttribute("height",e*a+"px"),1!==a&&this.contexts[s].scale(a,a)):(this.domElements[s].setAttribute("width",t*this.settings("webglOversamplingRatio")+"px"),this.domElements[s].setAttribute("height",e*this.settings("webglOversamplingRatio")+"px")));for(s in this.contexts)this.contexts[s]&&this.contexts[s].viewport&&this.contexts[s].viewport(0,0,this.width*this.settings("webglOversamplingRatio"),this.height*this.settings("webglOversamplingRatio"));return this},sigma.renderers.webgl.prototype.clear=function(){return this.contexts.labels.clearRect(0,0,this.width,this.height),this.contexts.nodes.clear(this.contexts.nodes.COLOR_BUFFER_BIT),this.contexts.edges.clear(this.contexts.edges.COLOR_BUFFER_BIT),this},sigma.renderers.webgl.prototype.kill=function(){for(var t,e;e=this.captors.pop();)e.kill();for(t in delete this.captors,this.domElements)this.domElements[t].parentNode.removeChild(this.domElements[t]),delete this.domElements[t],delete this.contexts[t];delete this.domElements,delete this.contexts},sigma.utils.pkg("sigma.webgl.nodes"),sigma.utils.pkg("sigma.webgl.edges"),sigma.utils.pkg("sigma.canvas.labels")}).call(this);