(function(f){"use strict";if("undefined"==typeof sigma)throw"sigma is not declared";if("undefined"==typeof conrad)throw"conrad is not declared";sigma.utils.pkg("sigma.renderers"),sigma.renderers.svg=function(e,s,t,i){if("object"!=typeof i)throw"sigma.renderers.svg: Wrong arguments.";if(!(i.container instanceof HTMLElement))throw"Container not found.";var n,r,d,h,o=this;for(sigma.classes.dispatcher.extend(this),this.graph=e,this.camera=s,this.domElements={graph:null,groups:{},nodes:{},edges:{},labels:{},hovers:{}},this.measurementCanvas=null,this.options=i,this.container=this.options.container,this.settings="object"==typeof i.settings&&i.settings?t.embedObjects(i.settings):t,this.settings("freeStyle",!!this.options.freeStyle),this.settings("xmlns","http://www.w3.org/2000/svg"),this.nodesOnScreen=[],this.edgesOnScreen=[],this.options.prefix="renderer"+sigma.utils.id()+":",this.initDOM("svg"),this.captors=[],n=0,r=(d=this.options.captors||[sigma.captors.mouse,sigma.captors.touch]).length;n<r;n++)h="function"==typeof d[n]?d[n]:sigma.captors[d[n]],this.captors.push(new h(this.domElements.graph,this.camera,this.settings));window.addEventListener("resize",function(){o.resize()}),sigma.misc.bindDOMEvents.call(this,this.domElements.graph),this.bindHovers(this.options.prefix),this.resize(!1)},sigma.renderers.svg.prototype.render=function(e){e=e||{};var s,t,i,n,r,d,h,o,a,m={},g=this.graph,l=this.graph.nodes,p=(this.options.prefix,this.settings(e,"drawEdges")),c=this.settings(e,"drawNodes"),u=(this.settings(e,"drawLabels"),this.settings.embedObjects(e,{prefix:this.options.prefix,forceLabels:this.options.forceLabels}));for(this.settings(e,"hideEdgesOnMove")&&(this.camera.isAnimated||this.camera.isMoving)&&(p=!1),this.camera.applyView(f,this.options.prefix,{width:this.width,height:this.height}),this.hideDOMElements(this.domElements.nodes),this.hideDOMElements(this.domElements.edges),this.hideDOMElements(this.domElements.labels),this.edgesOnScreen=[],this.nodesOnScreen=this.camera.quadtree.area(this.camera.getRectangle(this.width,this.height)),t=0,n=(s=this.nodesOnScreen).length;t<n;t++)m[s[t].id]=s[t];for(t=0,n=(s=g.edges()).length;t<n;t++)!m[(r=s[t]).source]&&!m[r.target]||r.hidden||l(r.source).hidden||l(r.target).hidden||this.edgesOnScreen.push(r);if(o=sigma.svg.nodes,a=sigma.svg.labels,c)for(t=0,n=(s=this.nodesOnScreen).length;t<n;t++)s[t].hidden||this.domElements.nodes[s[t].id]||(i=(o[s[t].type]||o.def).create(s[t],u),this.domElements.nodes[s[t].id]=i,this.domElements.groups.nodes.appendChild(i),i=(a[s[t].type]||a.def).create(s[t],u),this.domElements.labels[s[t].id]=i,this.domElements.groups.labels.appendChild(i));if(c)for(t=0,n=(s=this.nodesOnScreen).length;t<n;t++)s[t].hidden||((o[s[t].type]||o.def).update(s[t],this.domElements.nodes[s[t].id],u),(a[s[t].type]||a.def).update(s[t],this.domElements.labels[s[t].id],u));if(o=sigma.svg.edges,p)for(t=0,n=(s=this.edgesOnScreen).length;t<n;t++)this.domElements.edges[s[t].id]||(d=l(s[t].source),h=l(s[t].target),i=(o[s[t].type]||o.def).create(s[t],d,h,u),this.domElements.edges[s[t].id]=i,this.domElements.groups.edges.appendChild(i));if(p)for(t=0,n=(s=this.edgesOnScreen).length;t<n;t++)d=l(s[t].source),h=l(s[t].target),(o[s[t].type]||o.def).update(s[t],this.domElements.edges[s[t].id],d,h,u);return this.dispatchEvent("render"),this},sigma.renderers.svg.prototype.initDOM=function(e){var s,t,i,n=document.createElementNS(this.settings("xmlns"),e),r=this.settings("classPrefix");n.style.position="absolute",n.setAttribute("class",r+"-svg"),n.setAttribute("xmlns",this.settings("xmlns")),n.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttribute("version","1.1");var d=document.createElement("canvas");d.setAttribute("class",r+"-measurement-canvas"),this.domElements.graph=this.container.appendChild(n);var h=["edges","nodes","labels","hovers"];for(i=0,t=h.length;i<t;i++)(s=document.createElementNS(this.settings("xmlns"),"g")).setAttributeNS(null,"id",r+"-group-"+h[i]),s.setAttributeNS(null,"class",r+"-group"),this.domElements.groups[h[i]]=this.domElements.graph.appendChild(s);this.container.appendChild(d),this.measurementCanvas=d.getContext("2d")},sigma.renderers.svg.prototype.hideDOMElements=function(e){var s,t;for(t in e)s=e[t],sigma.svg.utils.hide(s);return this},sigma.renderers.svg.prototype.bindHovers=function(n){var r,d=sigma.svg.hovers,h=this;this.bind("overNode",function(e){var s=e.data.node,t=h.settings.embedObjects({prefix:n});if(t("enableHovering")){var i=(d[s.type]||d.def).create(s,h.domElements.nodes[s.id],h.measurementCanvas,t);h.domElements.hovers[s.id]=i,h.domElements.groups.hovers.appendChild(i),r=s}}),this.bind("outNode",function(e){var s=e.data.node;h.settings.embedObjects({prefix:n})("enableHovering")&&(h.domElements.groups.hovers.removeChild(h.domElements.hovers[s.id]),r=null,delete h.domElements.hovers[s.id],h.domElements.groups.nodes.appendChild(h.domElements.nodes[s.id]))}),this.bind("render",function(){if(r){var e=h.settings.embedObjects({prefix:n});h.domElements.groups.hovers.removeChild(h.domElements.hovers[r.id]),delete h.domElements.hovers[r.id];var s=(d[r.type]||d.def).create(r,h.domElements.nodes[r.id],h.measurementCanvas,e);h.domElements.hovers[r.id]=s,h.domElements.groups.hovers.appendChild(s)}})},sigma.renderers.svg.prototype.resize=function(e,s){var t=this.width,i=this.height;return e!==f&&s!==f?(this.width=e,this.height=s):(this.width=this.container.offsetWidth,this.height=this.container.offsetHeight,e=this.width,s=this.height),t===this.width&&i===this.height||(this.domElements.graph.style.width=e+"px",this.domElements.graph.style.height=s+"px","svg"===this.domElements.graph.tagName.toLowerCase()&&(this.domElements.graph.setAttribute("width",1*e),this.domElements.graph.setAttribute("height",1*s))),this},sigma.utils.pkg("sigma.svg.nodes"),sigma.utils.pkg("sigma.svg.edges"),sigma.utils.pkg("sigma.svg.labels")}).call(this);