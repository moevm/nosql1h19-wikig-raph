(function(w){"use strict";if("undefined"==typeof sigma)throw"sigma is not declared";if("undefined"==typeof conrad)throw"conrad is not declared";sigma.utils.pkg("sigma.renderers"),sigma.renderers.canvas=function(e,t,s,i){if("object"!=typeof i)throw"sigma.renderers.canvas: Wrong arguments.";if(!(i.container instanceof HTMLElement))throw"Container not found.";var n,h,o,a;for(sigma.classes.dispatcher.extend(this),Object.defineProperty(this,"conradId",{value:sigma.utils.id()}),this.graph=e,this.camera=t,this.contexts={},this.domElements={},this.options=i,this.container=this.options.container,this.settings="object"==typeof i.settings&&i.settings?s.embedObjects(i.settings):s,this.nodesOnScreen=[],this.edgesOnScreen=[],this.jobs={},this.options.prefix="renderer"+this.conradId+":",this.settings("batchEdgesDrawing")?(this.initDOM("canvas","edges"),this.initDOM("canvas","scene")):(this.initDOM("canvas","scene"),this.contexts.edges=this.contexts.scene),this.contexts.nodes=this.contexts.scene,this.contexts.labels=this.contexts.scene,this.initDOM("canvas","mouse"),this.contexts.hover=this.contexts.mouse,this.captors=[],n=0,h=(o=this.options.captors||[sigma.captors.mouse,sigma.captors.touch]).length;n<h;n++)a="function"==typeof o[n]?o[n]:sigma.captors[o[n]],this.captors.push(new a(this.domElements.mouse,this.camera,this.settings));sigma.misc.bindEvents.call(this,this.options.prefix),sigma.misc.drawHovers.call(this,this.options.prefix),this.resize(!1)},sigma.renderers.canvas.prototype.render=function(e){e=e||{};var t,s,i,n,h,o,a,r,d,c,g,l,m,p={},f=this.graph,u=this.graph.nodes,v=(this.options.prefix,this.settings(e,"drawEdges")),x=this.settings(e,"drawNodes"),b=this.settings(e,"drawLabels"),E=this.settings(e,"drawEdgeLabels"),y=this.settings.embedObjects(e,{prefix:this.options.prefix});for(i in this.resize(!1),this.settings(e,"hideEdgesOnMove")&&(this.camera.isAnimated||this.camera.isMoving)&&(v=!1),this.camera.applyView(w,this.options.prefix,{width:this.width,height:this.height}),this.clear(),this.jobs)conrad.hasJob(i)&&conrad.killJob(i);for(this.edgesOnScreen=[],this.nodesOnScreen=this.camera.quadtree.area(this.camera.getRectangle(this.width,this.height)),t=this.nodesOnScreen,s=0,n=t.length;s<n;s++)p[t[s].id]=t[s];if(v){for(t=f.edges(),s=0,n=t.length;s<n;s++)!p[(h=t[s]).source]&&!p[h.target]||h.hidden||u(h.source).hidden||u(h.target).hidden||this.edgesOnScreen.push(h);if(this.settings(e,"batchEdgesDrawing"))o="edges_"+this.conradId,l=y("canvasEdgesBatchSize"),n=(c=this.edgesOnScreen).length,d=0,a=Math.min(c.length,d+l),r=function(){for(m=this.contexts.edges.globalCompositeOperation,this.contexts.edges.globalCompositeOperation="destination-over",g=sigma.canvas.edges,s=d;s<a;s++)h=c[s],(g[h.type||this.settings(e,"defaultEdgeType")]||g.def)(h,f.nodes(h.source),f.nodes(h.target),this.contexts.edges,y);if(E)for(g=sigma.canvas.edges.labels,s=d;s<a;s++)(h=c[s]).hidden||(g[h.type||this.settings(e,"defaultEdgeType")]||g.def)(h,f.nodes(h.source),f.nodes(h.target),this.contexts.labels,y);return this.contexts.edges.globalCompositeOperation=m,a===c.length?(delete this.jobs[o],!1):(d=a+1,a=Math.min(c.length,d+l),!0)},this.jobs[o]=r,conrad.addJob(o,r.bind(this));else{for(g=sigma.canvas.edges,t=this.edgesOnScreen,s=0,n=t.length;s<n;s++)h=t[s],(g[h.type||this.settings(e,"defaultEdgeType")]||g.def)(h,f.nodes(h.source),f.nodes(h.target),this.contexts.edges,y);if(E)for(g=sigma.canvas.edges.labels,t=this.edgesOnScreen,s=0,n=t.length;s<n;s++)t[s].hidden||(g[t[s].type||this.settings(e,"defaultEdgeType")]||g.def)(t[s],f.nodes(t[s].source),f.nodes(t[s].target),this.contexts.labels,y)}}if(x)for(g=sigma.canvas.nodes,t=this.nodesOnScreen,s=0,n=t.length;s<n;s++)t[s].hidden||(g[t[s].type||this.settings(e,"defaultNodeType")]||g.def)(t[s],this.contexts.nodes,y);if(b)for(g=sigma.canvas.labels,t=this.nodesOnScreen,s=0,n=t.length;s<n;s++)t[s].hidden||(g[t[s].type||this.settings(e,"defaultNodeType")]||g.def)(t[s],this.contexts.labels,y);return this.dispatchEvent("render"),this},sigma.renderers.canvas.prototype.initDOM=function(e,t){var s=document.createElement(e);s.style.position="absolute",s.setAttribute("class","sigma-"+t),this.domElements[t]=s,this.container.appendChild(s),"canvas"===e.toLowerCase()&&(this.contexts[t]=s.getContext("2d"))},sigma.renderers.canvas.prototype.resize=function(e,t){var s,i=this.width,n=this.height,h=sigma.utils.getPixelRatio();if(e!==w&&t!==w?(this.width=e,this.height=t):(this.width=this.container.offsetWidth,this.height=this.container.offsetHeight,e=this.width,t=this.height),i!==this.width||n!==this.height)for(s in this.domElements)this.domElements[s].style.width=e+"px",this.domElements[s].style.height=t+"px","canvas"===this.domElements[s].tagName.toLowerCase()&&(this.domElements[s].setAttribute("width",e*h+"px"),this.domElements[s].setAttribute("height",t*h+"px"),1!==h&&this.contexts[s].scale(h,h));return this},sigma.renderers.canvas.prototype.clear=function(){for(var e in this.contexts)this.contexts[e].clearRect(0,0,this.width,this.height);return this},sigma.renderers.canvas.prototype.kill=function(){for(var e,t;t=this.captors.pop();)t.kill();for(e in delete this.captors,this.domElements)this.domElements[e].parentNode.removeChild(this.domElements[e]),delete this.domElements[e],delete this.contexts[e];delete this.domElements,delete this.contexts},sigma.utils.pkg("sigma.canvas.nodes"),sigma.utils.pkg("sigma.canvas.edges"),sigma.utils.pkg("sigma.canvas.labels")}).call(this);