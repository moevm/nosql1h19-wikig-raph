!function(e){"use strict";if(e.conrad)throw new Error("conrad already exists");var a,f=!1,u={},l={},s=[],h={},c=[],d=!1,g={frameDuration:20,history:!0},p=Object.create(null);function y(e,t){var r,n,i,o,a,f,s=Array.isArray(e)?e:e.split(/ /);for(t=void 0===t?{}:t,r=0,i=s.length;r!==i;r+=1)if(f=s[r],p[f])for(a={type:f,data:t||{}},n=0,o=p[f].length;n!==o;n+=1)try{p[f][n].handler(a)}catch(e){}}function n(){var e,t,r,n,i=!1,o=j(),a=s.shift();if(r=a.job(),o=j()-o,a.done++,a.time+=o,a.currentTime+=o,a.weightTime=a.currentTime/(a.weight||1),a.averageTime=a.time/a.done,!(n=a.count?a.count<=a.done:!r)){for(e=0,t=s.length;e<t;e++)if(s[e].weightTime>a.weightTime){s.splice(e,0,a),i=!0;break}i||s.push(a)}return n?a:null}function i(e){var t=s.length;(l[e.id]=e).status="running",t&&(e.weightTime=s[t-1].weightTime,e.currentTime=e.weightTime*(e.weight||1)),e.startTime=j(),y("jobStarted",A(e)),s.push(e)}function b(){var e,t,r;for(e in u)(t=u[e]).after?h[e]=t:i(t),delete u[e];for(f=!!s.length;s.length&&j()-a<g.frameDuration;)if(r=n())for(e in m(r.id),h)h[e].after===r.id&&(i(h[e]),delete h[e]);f?(a=j(),y("enterFrame"),setTimeout(b,0)):y("stop")}function m(e){var t,r,n,i,o=!1;if(Array.isArray(e))for(t=0,r=e.length;t<r;t++)m(e[t]);else{if("string"!=typeof e)throw new Error("[conrad.killJob] Wrong arguments.");for(t=0,r=(n=[l,h,u]).length;t<r;t++)e in n[t]&&(i=n[t][e],g.history&&(i.status="done",c.push(i)),y("jobEnded",A(i)),delete n[t][e],"function"==typeof i.end&&i.end(),o=!0);for(t=0,r=(n=s).length;t<r;t++)if(n[t].id===e){n.splice(t,1);break}if(!o)throw new Error('[conrad.killJob] Job "'+e+'" not found.')}return this}function w(e){var t=u[e]||l[e]||h[e];return t?v(t):null}function v(){var e,t,r={};for(e=arguments.length-1;0<=e;e--)for(t in arguments[e])r[t]=arguments[e][t];return r}function A(e){var t,r,n;if(!e)return e;if(Array.isArray(e))for(t=[],r=0,n=e.length;r<n;r++)t.push(A(e[r]));else if("object"==typeof e)for(r in t={},e)t[r]=A(e[r]);else t=e;return t}function T(e){var t,r=[];for(t in e)r.push(e[t]);return r}function j(){return Date.now?Date.now():(new Date).getTime()}Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var t={hasJob:w,addJob:function e(t,r){var n,i,o;if(Array.isArray(t)){for(d=!0,n=0,i=t.length;n<i;n++)e(t[n].id,v(t[n],r));d=!1,f||(a=j(),y("start"),b())}else if("object"==typeof t)if("string"==typeof t.id)e(t.id,t);else{for(n in d=!0,t)"function"==typeof t[n]?e(n,v({job:t[n]},r)):e(n,v(t[n],r));d=!1,f||(a=j(),y("start"),b())}else{if("string"!=typeof t)throw new Error("[conrad.addJob] Wrong arguments.");if(w(t))throw new Error('[conrad.addJob] Job with id "'+t+'" already exists.');if("function"==typeof r)o={id:t,done:0,time:0,status:"waiting",currentTime:0,averageTime:0,weightTime:0,job:r};else{if("object"!=typeof r)throw new Error("[conrad.addJob] Wrong arguments.");o=v({id:t,done:0,time:0,status:"waiting",currentTime:0,averageTime:0,weightTime:0},r)}y("jobAdded",A(u[t]=o)),f||d||(a=j(),y("start"),b())}return this},killJob:m,killAll:function(){var e,t=v(u,l,h);if(g.history)for(e in t)t[e].status="done",c.push(t[e]),"function"==typeof t[e].end&&t[e].end();return u={},h={},l={},s=[],f=!1,this},settings:function(e,t){var r;if("string"==typeof a1&&1===arguments.length)return g[a1];for(var n in r="object"==typeof a1&&1===arguments.length&&a1||{},"string"==typeof a1&&(r[a1]=a2),r)void 0!==r[n]?g[n]=r[n]:delete g[n];return this},getStats:function(e,t){var r,n,i,o,a,f,s;if(!arguments.length){for(n in a=[],u)a.push(u[n]);for(n in h)a.push(h[n]);for(n in l)a.push(l[n]);a=a.concat(c)}if("string"==typeof e)switch(e){case"waiting":a=T(h);break;case"running":a=T(l);break;case"done":a=c;break;default:f=e}if(e instanceof RegExp&&(f=e),!f&&("string"==typeof t||t instanceof RegExp)&&(f=t),f){if(s="string"==typeof f,a instanceof Array)r=a;else if("object"==typeof a)for(n in r=[],a)r=r.concat(a[n]);else{for(n in r=[],u)r.push(u[n]);for(n in h)r.push(h[n]);for(n in l)r.push(l[n]);r=r.concat(c)}for(a=[],i=0,o=r.length;i<o;i++)(s?r[i].id===f:r[i].id.match(f))&&a.push(r[i])}return A(a)},isRunning:function(){return f},clearHistory:function(){return c=[],this},bind:function e(t,r){var n,i,o,a;if(arguments.length)if(1===arguments.length&&Object(t)===t)for(t in t)e(t,t[t]);else if(1<arguments.length)for(n=0,i=(a=Array.isArray(t)?t:t.split(/ /)).length;n!==i;n+=1)o=a[n],p[o]||(p[o]=[]),p[o].push({handler:r})},unbind:function(e,t){var r,n,i,o,a,f,s=Array.isArray(e)?e:e.split(/ /);if(arguments.length)if(t)for(r=0,n=s.length;r!==n;r+=1){if(f=s[r],p[f]){for(a=[],i=0,o=p[f].length;i!==o;i+=1)p[f][i].handler!==t&&a.push(p[f][i]);p[f]=a}p[f]&&0===p[f].length&&delete p[f]}else for(r=0,n=s.length;r!==n;r+=1)delete p[s[r]];else p=Object.create(null)},version:"0.1.0"};"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports.conrad=t),e.conrad=t}(this);